let wondersCommon=require('./wondersCommon');(function(window){function wondersWeChats(){};var wxInitStatus=0;var jsSDKList=[];wondersWeChats.prototype.wondersWeChatInit=function(){let url=window.location.href.split('#')[0],that=this;wxInitStatus=1;this.loadJS('https://res.wx.qq.com/open/js/jweixin-1.6.0.js',function(){ajax({url:"https://public.hiunihealth.cn/api/jsSDK/healthyHaiNan/platform/pumpstation/jsSDK/createWXSign",type:'get',data:{url:url},dataType:'json',timeout:10000,contentType:"application/json",success:function(res){let data=JSON.parse(res).data;let jsApiList=['getLocation','chooseImage','scanQRCode','getLocalImgData'];that.wondersAppWeChatConfig(data,jsApiList)},error:function(e){console.log('接口请求错误',e)}})})};wondersWeChats.prototype.loadJS=function(src,callback){var script=document.createElement('script');var head=document.getElementsByTagName('head')[0];var loaded;script.src=src;if(typeof callback==='function'){script.onload=script.onreadystatechange=function(){if(!loaded&&(!script.readyState||/loaded|complete/.test(script.readyState))){script.onload=script.onreadystatechange=null;loaded=true;callback()}}};head.appendChild(script)};wondersWeChats.prototype.initUrlStorage=function(){console.log('initUrlStorage......');let weiXinDATA=JSON.parse(decodeURIComponent(this.getQueryVariable('weiXinDATA')));let wxData=null;if(weiXinDATA){if(typeof weiXinDATA==='string'){weiXinDATA=JSON.parse(weiXinDATA)}if(weiXinDATA&&weiXinDATA.length){weiXinDATA.forEach((element)=>{wxData={key:element['key'],value:element['value'],method:element['method']?element['method']:'set',};this.setNativeStorage(wxData)})}}};wondersWeChats.prototype.getQueryVariable=function(variable){var query=window.location.href.split('?');var vars=query[1]&&query[1].split('&');if(vars&&vars.length){for(var i=0;i<vars.length;i++){var pair=vars[i].split('=');if(pair[0]==variable){return pair[1]}}}return false};wondersWeChats.prototype.setNativeStorage=function(data){let key=data.key;if(data.method=='set'){localStorage[key]=data.value}else if(data.method=='delete'){localStorage.removeItem(key)}};wondersWeChats.prototype.wondersAppWeChatConfig=function(data,jsApiList){let that=this;wx.config({debug:false,appId:data.appId,timestamp:data.timestamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:jsApiList});wx.ready(function(){wxInitStatus=2;jsSDKList.forEach((element,index)=>{that[element.method](element.data).then(res=>{jsSDKList[index].callback(res)})})})};wondersWeChats.prototype.wondersWxJsSDKApi=function(method,data,callback){switch(wxInitStatus){case 0:jsSDKList.push({method,data,callback});if(jsSDKList.length<=1){this.wondersWeChatInit()}break;case 1:jsSDKList.push({method,callback});break;case 2:this[method](data).then(res=>{callback(res)});break}};wondersWeChats.prototype.getLocation=function(data){return new Promise((resolve,reject)=>{wx.getLocation({type:'gcj02',success:function(res){if(data.coordinate=='2'){let locationResult=wondersCommon.gcj02tobd09(res.longitude,res.latitude);res.longitude=locationResult[0];res.latitude=locationResult[1]}let backResult={code:0,msg:'success',longitude:res.longitude,latitude:res.latitude,};resolve(backResult)}})})};wondersWeChats.prototype.chooseImage=function(data){let that=this;return new Promise((resolve,reject)=>{let sizeType=['original'];let count=1;if(data.maxCount){count=parseInt(data.maxCount)}if(data.quality){if(data.quality>0.5){sizeType=['original']}else{sizeType=['compressed']}}wx.chooseImage({count:count,sizeType:sizeType,sourceType:['album'],success:function(res){let images=[];res.localIds.forEach((element)=>{that.getLocalImgData(element).then(res=>{images.push(res)})});let backResult={code:0,msg:'success',images};resolve(backResult)}})})};wondersWeChats.prototype.getLocalImgData=function(localId){return new Promise((resolve,reject)=>{wx.getLocalImgData({localId:localId.toString(),success:function(res){const localData=res.localData;let imageBase64='';if(localData.indexOf('data:image')==0){imageBase64=localData}else{imageBase64='data:image/jpeg;base64,'+localData.replace(/\n/g,'')}resolve(imageBase64)}})})};wondersWeChats.prototype.camera=function(data){let that=this;return new Promise((resolve,reject)=>{wx.chooseImage({count:1,sizeType:['original','compressed'],sourceType:['camera'],success:function(res){that.getLocalImgData(res.localIds[0]).then(res=>{let backResult={code:0,msg:'success',avatar:res};resolve(backResult)})}})})};wondersWeChats.prototype.qrCodeScan=function(data){return new Promise((resolve,reject)=>{wx.scanQRCode({needResult:parseInt(data.needResult),scanType:["qrCode"],success:function(res){let backResult={code:0,msg:'',qrcode:res.resultStr,};resolve(backResult)}})})};wondersWeChats.prototype.callPhone=function(data,callback){if(data.mode==='call'){var a=document.createElement('a');a.setAttribute('href','tel:'+data.phoneNumber);a.style.display='block';document.body.appendChild(a);a.click();document.body.removeChild(a)}};wondersWeChats.prototype.showMapRoute=function(data,callback){var locationMessage={current_location:{sName:data.sName,sLat:data.sLat,sLon:data.sLon,},target_location:{tName:data.tName,tLat:data.tLat,tLon:data.tLon,},};wx.miniProgram.navigateTo({url:'/pages/mapNavigation/mapNavigation?locationMessage='+JSON.stringify(locationMessage),})};wondersWeChats.prototype.wxPay=function(data,callback){var requestPaymentMessage={wxPayMessage:data.wxPayMessage,redirect_url:data.redirect_url};wx.miniProgram.navigateTo({url:'/pages/wxRequestPayment/wxRequestPayment?requestPaymentMessage='+JSON.stringify(requestPaymentMessage),})};var wondersWeChat=new wondersWeChats();if(typeof module!=='undefined'&&typeof module.exports!=='undefined'){module.exports=wondersWeChat}else{window.wondersWeChat=wondersWeChat}})(window);function ajax(options){options=options||{};options.type=(options.type||"GET").toUpperCase();options.dataType=options.dataType||"json";var params=formatParams(options.data);var xhr;if(window.XMLHttpRequest){xhr=new XMLHttpRequest()}else if(window.ActiveObject){xhr=new ActiveXobject('Microsoft.XMLHTTP')}if(options.type=="GET"){xhr.open("GET",options.url+"?"+params,true);xhr.send(null)}else if(options.type=="POST"){xhr.open("post",options.url,true);xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");xhr.send(params)}setTimeout(function(){if(xhr.readySate!=4){xhr.abort()}},options.timeout);xhr.onreadystatechange=function(){if(xhr.readyState==4){var status=xhr.status;if(status>=200&&status<300||status==304){options.success&&options.success(xhr.responseText,xhr.responseXML)}else{options.error&&options.error(status)}}}};function formatParams(data){var arr=[];for(var name in data){arr.push(encodeURIComponent(name)+"="+encodeURIComponent(data[name]))}arr.push(("v="+Math.random()).replace(".",""));return arr.join("&")};